<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Bahn-Bingo">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Bahn-Bingo">
    <meta name="description" content="Das ultimative soziale Bahn-Bingo Spiel">
    
    <title>Bahn-Bingo Social</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 20px;
            position: relative;
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .login-card h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #333;
        }
        
        .login-card p {
            color: #666;
            margin-bottom: 30px;
        }
        
        .username-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .username-input:focus {
            outline: none;
            border-color: #667eea;
            transform: scale(1.02);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .google-login-btn {
            width: 100%;
            padding: 15px;
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .google-login-btn:hover {
            background: #f8f8f8;
            transform: translateY(-2px);
        }
        
        /* Navigation Bar */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #999;
        }
        
        .nav-item.active {
            color: #667eea;
        }
        
        .nav-item:active {
            transform: scale(0.95);
        }
        
        .nav-icon {
            font-size: 1.5em;
            margin-bottom: 3px;
        }
        
        .nav-label {
            font-size: 0.7em;
            font-weight: 600;
        }
        
        /* Screens */
        .screen {
            display: none;
            padding-bottom: 80px;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Profile Header */
        .profile-header {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: white;
            font-weight: bold;
        }
        
        .user-details h2 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .user-details p {
            color: #666;
            font-size: 0.9em;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
        }
        
        /* Game Container */
        .game-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        /* Live Game Info */
        .live-game-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .live-game-info h3 {
            margin-bottom: 10px;
        }
        
        .live-players {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .live-player {
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        /* Friends List */
        .friends-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .friends-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .friend-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        
        .friend-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #2ecc71;
        }
        
        .offline-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #95a5a6;
        }
        
        /* Leaderboard */
        .leaderboard {
            background: white;
            border-radius: 20px;
            padding: 20px;
        }
        
        .leaderboard h3 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }
        
        .leaderboard-rank {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .rank-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }
        
        .rank-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #333;
        }
        
        .rank-3 {
            background: linear-gradient(135deg, #cd7f32, #e4a853);
            color: white;
        }
        
        .rank-other {
            background: #e9ecef;
            color: #666;
        }
        
        .leaderboard-player {
            flex: 1;
        }
        
        .leaderboard-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }
        
        /* Create Game Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            animation: bounceIn 0.5s ease;
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .modal-content h3 {
            color: #333;
            margin-bottom: 20px;
        }
        
        .game-code-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .game-code {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
        }
        
        .join-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.2em;
            text-align: center;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 20px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .action-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* Bingo Grid */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            background: #333;
            margin-bottom: 20px;
        }
        
        .header-cell {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #333;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .bingo-cell {
            background: white;
            border: 1px solid #333;
            padding: 10px 6px;
            text-align: center;
            min-height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.82em;
            line-height: 1.2;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }
        
        .bingo-cell:active {
            transform: scale(0.95);
        }
        
        .bingo-cell.marked {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #333;
            font-weight: bold;
            animation: markCell 0.5s ease;
        }
        
        .bingo-cell.marked::before {
            content: "‚úì";
            position: absolute;
            top: 3px;
            right: 3px;
            color: #2ecc71;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .free-space {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            font-weight: bold;
            color: #333;
        }
        
        .free-space::after {
            content: "‚≠ê";
            display: block;
            font-size: 1.3em;
            margin-top: 3px;
        }
        
        @keyframes markCell {
            0% {
                transform: scale(1) rotate(0deg);
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            z-index: 3000;
            animation: slideInRight 0.5s ease;
        }
        
        .notification.show {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .notification.success {
            border-left: 4px solid #2ecc71;
        }
        
        .notification.error {
            border-left: 4px solid #e74c3c;
        }
        
        .notification.info {
            border-left: 4px solid #3498db;
        }
        
        /* Loading Spinner */
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4000;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .bingo-cell {
                font-size: 0.68em;
                min-height: 70px;
                padding: 6px 3px;
                line-height: 1.15;
            }
            
            .header-cell {
                font-size: 1.3em;
                padding: 8px;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <h1>üöÇ Bahn-Bingo</h1>
            <p>Das soziale Bingo-Spiel f√ºr deine Bahnfahrt!</p>
            
            <input type="text" class="username-input" id="usernameInput" 
                   placeholder="Dein Benutzername" maxlength="20">
            
            <button class="login-btn" id="loginBtn" onclick="loginWithUsername()">
                Los geht's!
            </button>
            
            <button class="google-login-btn" onclick="loginWithGoogle()">
                <span>üîµ</span> Mit Google anmelden
            </button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Game Screen -->
        <div class="screen active" id="gameScreen">
            <div class="profile-header">
                <div class="profile-info">
                    <div class="avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">Spieler</h2>
                        <p id="userStatus">Bereit zum Spielen!</p>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="gamesWonStat">0</div>
                        <div class="stat-label">Gewonnen</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalGamesStat">0</div>
                        <div class="stat-label">Gespielt</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="friendsCount">0</div>
                        <div class="stat-label">Freunde</div>
                    </div>
                </div>
            </div>
            
            <div class="live-game-info" id="liveGameInfo" style="display: none;">
                <h3>üéÆ Live-Spiel l√§uft!</h3>
                <p>Code: <strong id="gameCode">ABCD</strong></p>
                <div class="live-players" id="livePlayers"></div>
            </div>
            
            <div class="game-container">
                <div class="bingo-grid" id="bingoGrid">
                    <!-- Header Row -->
                    <div class="header-cell">B</div>
                    <div class="header-cell">I</div>
                    <div class="header-cell">N</div>
                    <div class="header-cell">G</div>
                    <div class="header-cell">O</div>
                    
                    <!-- Bingo cells will be generated here -->
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn" onclick="createGame()">
                        üéÆ Spiel erstellen
                    </button>
                    <button class="action-btn secondary" onclick="showJoinGame()">
                        üîó Spiel beitreten
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Friends Screen -->
        <div class="screen" id="friendsScreen">
            <div class="friends-section">
                <h3>üë• Deine Freunde</h3>
                <div id="friendsList">
                    <p style="text-align: center; color: #999; padding: 20px;">
                        Noch keine Freunde hinzugef√ºgt.<br>
                        Teile deinen Benutzernamen!
                    </p>
                </div>
                
                <input type="text" class="join-input" id="addFriendInput" 
                       placeholder="Benutzername eingeben" style="margin-top: 20px;">
                <button class="action-btn" onclick="addFriend()">
                    Freund hinzuf√ºgen
                </button>
            </div>
        </div>
        
        <!-- Leaderboard Screen -->
        <div class="screen" id="leaderboardScreen">
            <div class="leaderboard">
                <h3>üèÜ Rangliste</h3>
                <div id="leaderboardList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Profile Screen -->
        <div class="screen" id="profileScreen">
            <div class="profile-header">
                <div class="profile-info">
                    <div class="avatar" id="profileAvatar">?</div>
                    <div class="user-details">
                        <h2 id="profileName">Spieler</h2>
                        <p>Mitglied seit: <span id="memberSince">Heute</span></p>
                    </div>
                </div>
            </div>
            
            <div class="friends-section">
                <h3>üìä Statistiken</h3>
                <div class="profile-stats" style="padding: 0;">
                    <div class="stat-item">
                        <div class="stat-value" id="winRate">0%</div>
                        <div class="stat-label">Gewinnrate</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgTime">--</div>
                        <div class="stat-label">√ò Zeit</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-label">Beste Serie</div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="action-btn secondary" onclick="logout()">
                    üö™ Abmelden
                </button>
                <button class="action-btn" onclick="shareProfile()">
                    üì§ Profil teilen
                </button>
            </div>
        </div>
        
        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="switchScreen('gameScreen')">
                <div class="nav-icon">üéÆ</div>
                <div class="nav-label">Spielen</div>
            </div>
            <div class="nav-item" onclick="switchScreen('friendsScreen')">
                <div class="nav-icon">üë•</div>
                <div class="nav-label">Freunde</div>
            </div>
            <div class="nav-item" onclick="switchScreen('leaderboardScreen')">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-label">Rangliste</div>
            </div>
            <div class="nav-item" onclick="switchScreen('profileScreen')">
                <div class="nav-icon">üë§</div>
                <div class="nav-label">Profil</div>
            </div>
        </div>
    </div>
    
    <!-- Create/Join Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-content">
            <h3 id="modalTitle">Spiel erstellen</h3>
            
            <div class="game-code-display" id="gameCodeDisplay" style="display: none;">
                <p>Teile diesen Code mit deinen Freunden:</p>
                <div class="game-code" id="gameCodeText">ABCD</div>
            </div>
            
            <input type="text" class="join-input" id="joinGameInput" 
                   placeholder="CODE" maxlength="4" style="display: none;">
            
            <div class="action-buttons">
                <button class="action-btn secondary" onclick="closeModal()">
                    Abbrechen
                </button>
                <button class="action-btn" id="modalActionBtn" onclick="startGame()">
                    Spiel starten
                </button>
            </div>
            
            <div id="waitingPlayers" style="margin-top: 20px; display: none;">
                <p style="color: #666; text-align: center;">Warte auf Spieler...</p>
                <div class="live-players" id="modalPlayers"></div>
            </div>
        </div>
    </div>
    
    <!-- Notifications -->
    <div class="notification" id="notification"></div>
    
    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <script>
        // Firebase Configuration (you need to replace with your own)
        const firebaseConfig = {
            apiKey: "AIzaSyD_DEMO_KEY_REPLACE_THIS",
            authDomain: "bahn-bingo.firebaseapp.com",
            projectId: "bahn-bingo",
            storageBucket: "bahn-bingo.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // Initialize Firebase (will work in demo mode without real config)
        let firebase, auth, db, currentUser;
        
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) {
            console.log("Firebase Demo Mode");
        }
        
        // Event Pool
        const eventPool = {
            versp√§tung: [
                "Versp√§tung √ºber 10 Min",
                "Versp√§tung √ºber 20 Min", 
                "Versp√§tung √ºber 30 Min",
                "Versp√§tung √ºber 5 Min",
                "P√ºnktliche Abfahrt"
            ],
            technik: [
                "Defekte Klimaanlage",
                "Defekte Heizung",
                "Defekte T√ºr",
                "Defektes WC",
                "Kein WLAN",
                "Kein Strom",
                "Technische St√∂rung"
            ],
            durchsagen: [
                "Durchsage unklar",
                "Durchsage zu leise",
                "Durchsage wiederholt",
                "Keine Durchsage"
            ],
            mitreisende: [
                "Schreiende Kinder",
                "Laute Musik",
                "Lautes Telefonat",
                "F√º√üe auf Sitz",
                "Betrunkene",
                "Fu√üballfans",
                "Schnarchen"
            ],
            zugprobleme: [
                "Zugausfall",
                "Zug f√§hrt durch",
                "Falscher Zugtyp",
                "Ersatzverkehr",
                "Zug √ºberf√ºllt"
            ],
            gleise: [
                "Gleis√§nderung",
                "Falsches Gleis",
                "Bahnsteig zu kurz"
            ],
            strecke: [
                "Signalst√∂rung",
                "Streckensperrung",
                "Notarzteinsatz",
                "Personen im Gleis",
                "Polizeieinsatz",
                "Weichenst√∂rung"
            ],
            sitzpl√§tze: [
                "Kein Sitzplatz",
                "Sitz besetzt",
                "Sitz defekt",
                "Tisch klebrig"
            ],
            halt: [
                "Au√üerplanm√§√üiger Halt",
                "Halt entf√§llt",
                "Halt auf freier Strecke"
            ],
            anschluss: [
                "Anschluss verpasst",
                "Anschluss wartet",
                "Rennen zum Anschluss"
            ],
            wagen: [
                "Fehlende Wagen",
                "Falsche Reihenfolge",
                "Erste Klasse voll"
            ]
        };
        
        // Game State
        let gameState = {
            username: '',
            userId: '',
            currentGameId: null,
            isHost: false,
            board: [],
            marked: [],
            stats: {
                gamesWon: 0,
                totalGames: 0,
                friends: []
            }
        };
        
        // Demo Mode Data (when Firebase is not configured)
        const demoData = {
            users: {},
            games: {},
            leaderboard: [
                { name: "ZugProfi", wins: 42 },
                { name: "BahnMeister", wins: 38 },
                { name: "Versp√§tungsK√∂nig", wins: 35 },
                { name: "GleisHeld", wins: 28 },
                { name: "ICE_Rider", wins: 24 }
            ]
        };
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            generateBingoBoard();
        });
        
        // Authentication
        function checkAuth() {
            const savedUser = localStorage.getItem('bahnBingoUser');
            if (savedUser) {
                gameState = JSON.parse(savedUser);
                showMainApp();
                updateUI();
            }
        }
        
        function loginWithUsername() {
            const username = document.getElementById('usernameInput').value.trim();
            if (username.length < 3) {
                showNotification('Benutzername muss mindestens 3 Zeichen haben', 'error');
                return;
            }
            
            gameState.username = username;
            gameState.userId = 'user_' + Date.now();
            
            // Save to localStorage
            localStorage.setItem('bahnBingoUser', JSON.stringify(gameState));
            
            // Save to demo data
            demoData.users[gameState.userId] = {
                username: username,
                stats: gameState.stats,
                joinedAt: new Date().toISOString()
            };
            
            showMainApp();
            updateUI();
            showNotification(`Willkommen ${username}! üöÇ`, 'success');
        }
        
        function loginWithGoogle() {
            showNotification('Google Login kommt bald!', 'info');
            // In real implementation: auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
        }
        
        function logout() {
            localStorage.removeItem('bahnBingoUser');
            location.reload();
        }
        
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }
        
        // UI Updates
        function updateUI() {
            // Update user info
            document.getElementById('userName').textContent = gameState.username;
            document.getElementById('profileName').textContent = gameState.username;
            document.getElementById('userAvatar').textContent = gameState.username[0].toUpperCase();
            document.getElementById('profileAvatar').textContent = gameState.username[0].toUpperCase();
            
            // Update stats
            document.getElementById('gamesWonStat').textContent = gameState.stats.gamesWon;
            document.getElementById('totalGamesStat').textContent = gameState.stats.totalGames;
            document.getElementById('friendsCount').textContent = gameState.stats.friends.length;
            
            // Calculate win rate
            const winRate = gameState.stats.totalGames > 0 
                ? Math.round((gameState.stats.gamesWon / gameState.stats.totalGames) * 100) 
                : 0;
            document.getElementById('winRate').textContent = winRate + '%';
            
            // Update leaderboard
            updateLeaderboard();
        }
        
        // Screen Navigation
        function switchScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            // Show selected screen
            document.getElementById(screenId).classList.add('active');
            
            // Update nav bar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }
        
        // Bingo Board Generation
        function generateBingoBoard() {
            const selectedEvents = [];
            const usedCategories = new Set();
            
            while (selectedEvents.length < 24) {
                const availableCategories = Object.keys(eventPool).filter(cat => !usedCategories.has(cat));
                
                if (availableCategories.length === 0) {
                    usedCategories.clear();
                    continue;
                }
                
                const randomCategory = availableCategories[Math.floor(Math.random() * availableCategories.length)];
                const events = eventPool[randomCategory];
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                
                if (!selectedEvents.includes(randomEvent)) {
                    selectedEvents.push(randomEvent);
                    usedCategories.add(randomCategory);
                }
            }
            
            // Shuffle
            for (let i = selectedEvents.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [selectedEvents[i], selectedEvents[j]] = [selectedEvents[j], selectedEvents[i]];
            }
            
            selectedEvents.splice(12, 0, "FREI");
            gameState.board = selectedEvents;
            
            // Populate grid
            const grid = document.getElementById('bingoGrid');
            
            // Clear existing cells (keep headers)
            const headers = grid.querySelectorAll('.header-cell');
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));
            
            // Add cells
            selectedEvents.forEach((event, index) => {
                const cell = document.createElement('div');
                cell.className = 'bingo-cell';
                if (index === 12) {
                    cell.className += ' free-space marked';
                }
                cell.textContent = event;
                cell.onclick = () => markCell(index);
                grid.appendChild(cell);
            });
        }
        
        function markCell(index) {
            if (index === 12) return; // Free space
            
            const cells = document.querySelectorAll('.bingo-cell');
            cells[index].classList.toggle('marked');
            
            if (cells[index].classList.contains('marked')) {
                gameState.marked.push(index);
            } else {
                gameState.marked = gameState.marked.filter(i => i !== index);
            }
            
            checkWin();
            
            // Vibrate if available
            if (window.navigator.vibrate) {
                window.navigator.vibrate(10);
            }
            
            // If in live game, update Firebase
            if (gameState.currentGameId && db) {
                updateLiveGame();
            }
        }
        
        function checkWin() {
            const cells = Array.from(document.querySelectorAll('.bingo-cell'));
            const grid = [];
            for (let i = 0; i < 5; i++) {
                grid.push(cells.slice(i * 5, (i + 1) * 5));
            }
            
            let won = false;
            
            // Check rows, columns, diagonals
            for (let row of grid) {
                if (row.every(cell => cell.classList.contains('marked'))) {
                    won = true;
                    break;
                }
            }
            
            if (!won) {
                for (let col = 0; col < 5; col++) {
                    if (grid.every(row => row[col].classList.contains('marked'))) {
                        won = true;
                        break;
                    }
                }
            }
            
            if (!won) {
                if (grid.every((row, i) => row[i].classList.contains('marked'))) {
                    won = true;
                }
                if (grid.every((row, i) => row[4 - i].classList.contains('marked'))) {
                    won = true;
                }
            }
            
            if (won) {
                celebrate();
            }
        }
        
        function celebrate() {
            gameState.stats.gamesWon++;
            gameState.stats.totalGames++;
            localStorage.setItem('bahnBingoUser', JSON.stringify(gameState));
            
            showNotification('üéâ BINGO! Du hast gewonnen! üéâ', 'success');
            
            if (window.navigator.vibrate) {
                window.navigator.vibrate([100, 50, 100, 50, 200]);
            }
            
            updateUI();
            
            setTimeout(() => {
                if (confirm('Neue Runde starten?')) {
                    newGame();
                }
            }, 1000);
        }
        
        function newGame() {
            gameState.marked = [];
            generateBingoBoard();
            gameState.stats.totalGames++;
            localStorage.setItem('bahnBingoUser', JSON.stringify(gameState));
            updateUI();
        }
        
        // Multiplayer Functions
        function createGame() {
            const code = generateGameCode();
            gameState.currentGameId = code;
            gameState.isHost = true;
            
            document.getElementById('modalTitle').textContent = 'Spiel erstellt!';
            document.getElementById('gameCodeDisplay').style.display = 'block';
            document.getElementById('gameCodeText').textContent = code;
            document.getElementById('joinGameInput').style.display = 'none';
            document.getElementById('modalActionBtn').textContent = 'Spiel starten';
            document.getElementById('waitingPlayers').style.display = 'block';
            
            document.getElementById('gameModal').classList.add('show');
            
            // Demo: Add to games
            demoData.games[code] = {
                host: gameState.username,
                players: [gameState.username],
                board: gameState.board,
                createdAt: Date.now()
            };
        }
        
        function showJoinGame() {
            document.getElementById('modalTitle').textContent = 'Spiel beitreten';
            document.getElementById('gameCodeDisplay').style.display = 'none';
            document.getElementById('joinGameInput').style.display = 'block';
            document.getElementById('joinGameInput').value = '';
            document.getElementById('modalActionBtn').textContent = 'Beitreten';
            document.getElementById('modalActionBtn').onclick = joinGame;
            document.getElementById('waitingPlayers').style.display = 'none';
            
            document.getElementById('gameModal').classList.add('show');
        }
        
        function joinGame() {
            const code = document.getElementById('joinGameInput').value.toUpperCase();
            
            if (demoData.games[code]) {
                gameState.currentGameId = code;
                gameState.board = demoData.games[code].board;
                demoData.games[code].players.push(gameState.username);
                
                showNotification(`Spiel ${code} beigetreten!`, 'success');
                closeModal();
                startLiveGame();
            } else {
                showNotification('Ung√ºltiger Spielcode!', 'error');
            }
        }
        
        function startGame() {
            if (gameState.isHost) {
                startLiveGame();
                closeModal();
            }
        }
        
        function startLiveGame() {
            document.getElementById('liveGameInfo').style.display = 'block';
            document.getElementById('gameCode').textContent = gameState.currentGameId;
            
            // Update live players
            if (demoData.games[gameState.currentGameId]) {
                const players = demoData.games[gameState.currentGameId].players;
                const playersHtml = players.map(p => 
                    `<div class="live-player">${p}</div>`
                ).join('');
                document.getElementById('livePlayers').innerHTML = playersHtml;
            }
        }
        
        function updateLiveGame() {
            // In real implementation: Update Firebase with marked cells
            console.log('Updating live game...');
        }
        
        function generateGameCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }
        
        // Friends Functions
        function addFriend() {
            const friendName = document.getElementById('addFriendInput').value.trim();
            if (!friendName) return;
            
            if (!gameState.stats.friends.includes(friendName)) {
                gameState.stats.friends.push(friendName);
                localStorage.setItem('bahnBingoUser', JSON.stringify(gameState));
                updateUI();
                updateFriendsList();
                showNotification(`${friendName} wurde hinzugef√ºgt!`, 'success');
            } else {
                showNotification('Bereits befreundet!', 'error');
            }
            
            document.getElementById('addFriendInput').value = '';
        }
        
        function updateFriendsList() {
            const friendsList = document.getElementById('friendsList');
            
            if (gameState.stats.friends.length === 0) {
                friendsList.innerHTML = `
                    <p style="text-align: center; color: #999; padding: 20px;">
                        Noch keine Freunde hinzugef√ºgt.<br>
                        Teile deinen Benutzernamen!
                    </p>
                `;
                return;
            }
            
            friendsList.innerHTML = gameState.stats.friends.map(friend => `
                <div class="friend-item">
                    <div class="friend-info">
                        <div class="friend-avatar">${friend[0].toUpperCase()}</div>
                        <div>
                            <strong>${friend}</strong>
                        </div>
                    </div>
                    <div class="friend-status">
                        <div class="offline-indicator"></div>
                        <span style="color: #999; font-size: 0.9em;">Offline</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Leaderboard
        function updateLeaderboard() {
            const leaderboardList = document.getElementById('leaderboardList');
            
            // Add current user to demo leaderboard if not there
            const currentUserInLeaderboard = demoData.leaderboard.find(p => p.name === gameState.username);
            if (!currentUserInLeaderboard && gameState.username) {
                demoData.leaderboard.push({
                    name: gameState.username,
                    wins: gameState.stats.gamesWon
                });
            } else if (currentUserInLeaderboard) {
                currentUserInLeaderboard.wins = gameState.stats.gamesWon;
            }
            
            // Sort by wins
            const sorted = [...demoData.leaderboard].sort((a, b) => b.wins - a.wins);
            
            leaderboardList.innerHTML = sorted.slice(0, 10).map((player, index) => {
                const rankClass = index === 0 ? 'rank-1' : 
                                 index === 1 ? 'rank-2' : 
                                 index === 2 ? 'rank-3' : 'rank-other';
                
                return `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank ${rankClass}">
                            ${index + 1}
                        </div>
                        <div class="leaderboard-player">
                            <strong>${player.name}</strong>
                            ${player.name === gameState.username ? ' (Du)' : ''}
                        </div>
                        <div class="leaderboard-score">
                            ${player.wins} üèÜ
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Share Functions
        function shareProfile() {
            const text = `Ich bin ${gameState.username} bei Bahn-Bingo! üöÇ\n` +
                        `${gameState.stats.gamesWon} Spiele gewonnen!\n` +
                        `F√ºge mich als Freund hinzu!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Bahn-Bingo Profil',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text);
                showNotification('Profil-Link kopiert!', 'success');
            }
        }
        
        // Modal Functions
        function closeModal() {
            document.getElementById('gameModal').classList.remove('show');
        }
        
        // Notifications
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Loading
        function showLoading() {
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading').classList.remove('show');
        }
    </script>
</body>
</html>
